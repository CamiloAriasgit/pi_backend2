# Backend - Project Enterprise Management System (PEMS) üí´

## Description üìã
Sistema de gesti√≥n empresarial que permite administrar usuarios, transacciones, documentos, proveedores, centros de costos y almacenes con autenticaci√≥n JWT y control de acceso basado en roles (RBAC).

## üîê Sistema de Autenticaci√≥n y Seguridad

### Caracter√≠sticas de Seguridad
- **Autenticaci√≥n JWT** con tokens de acceso y refresh
- **Control de acceso basado en roles (RBAC)** con permisos granulares
- **Hash de contrase√±as** con bcrypt (Argon2id disponible)
- **Auditor√≠a completa** de eventos de autenticaci√≥n y cambios
- **Blacklist de tokens** para invalidaci√≥n segura
- **MFA (Multi-Factor Authentication)** preparado
- **Rate limiting** y bloqueo de cuentas por intentos fallidos

### Variables de Entorno Requeridas

```bash
# Base de datos
DB_URL=jdbc:postgresql://localhost:5432/pib2
DB_USERNAME=tu_usuario
DB_PASSWORD=tu_contrase√±a

# JWT Configuration
JWT_SECRET=tu_clave_secreta_muy_larga_y_segura_minimo_256_bits
JWT_ACCESS_TTL=15m
JWT_REFRESH_TTL=30d

# Opcional: Para cifrado de datos sensibles
ENCRYPTION_KEY=clave_de_cifrado_32_caracteres

# Opcional: Para JWT con RS256 (m√°s seguro)
# JWT_PRIVATE_KEY=path/to/private.pem
# JWT_PUBLIC_KEY=path/to/public.pem
```

### Roles y Permisos

#### Roles Disponibles
- **ADMIN**: Acceso completo al sistema
- **MANAGER**: Gesti√≥n de usuarios y operaciones
- **USER**: Usuario est√°ndar con permisos b√°sicos
- **AUDITOR**: Solo lectura y exportaci√≥n de logs
- **FINANCE**: Permisos espec√≠ficos para operaciones financieras

#### Permisos Granulares
- `users.*`: Gesti√≥n de usuarios
- `roles.*`: Gesti√≥n de roles
- `permissions.*`: Gesti√≥n de permisos
- `auth.*`: Operaciones de autenticaci√≥n
- `audit.*`: Acceso a logs de auditor√≠a
- `system.*`: Administraci√≥n del sistema
- `companies.*`, `cost_centers.*`, `third_parties.*`, `documents.*`, `transactions.*`, `warehouses.*`: Permisos espec√≠ficos por m√≥dulo

### Seguridad de Contrase√±as

**¬øPor qu√© hash en lugar de cifrado?**
- **Hash (bcrypt/Argon2id)**: Irreversible, resistente a ataques de fuerza bruta
- **Cifrado**: Reversible, vulnerable si se compromete la clave
- **Almacenamiento**: Solo el hash se guarda, nunca la contrase√±a original
- **Verificaci√≥n**: Se compara el hash de la entrada con el almacenado

### Gesti√≥n de Base de Datos

El proyecto usa un enfoque h√≠brido:

1. **Hibernate DDL** para crear/actualizar el esquema de tablas autom√°ticamente
2. **Flyway** solo para seeds de datos iniciales

```bash
# Ejecutar la aplicaci√≥n (crea tablas autom√°ticamente + ejecuta seeds)
mvn spring-boot:run

# O ejecutar solo seeds manualmente
mvn flyway:migrate

# Verificar estado de migraciones
mvn flyway:info
```

**Estructura de migraciones (solo seeds):**
```
src/main/resources/db/migration/
‚îú‚îÄ‚îÄ V1__Seed_initial_roles_and_permissions.sql  # Roles y permisos iniciales
‚îú‚îÄ‚îÄ V2__Seed_admin_user.sql                     # Usuario administrador inicial
‚îî‚îÄ‚îÄ V3__Seed_test_users.sql                     # Usuarios de prueba para testing
```

**Entidades JPA** crean autom√°ticamente las tablas:
- `User`, `Role`, `Permission` - Tablas principales
- `RefreshToken`, `AuthEvent`, `AuditLog`, `JwtBlacklist` - Tablas de soporte
- Relaciones many-to-many: `user_roles`, `role_permissions`

### C√≥mo Ejecutar en Local

1. **Configurar variables de entorno:**
   ```bash
   # Crear archivo .env en la ra√≠z del proyecto
   DB_URL=jdbc:postgresql://localhost:5432/pib2
   DB_USERNAME=postgres
   DB_PASSWORD=tu_contrase√±a
   JWT_SECRET=mi_clave_secreta_muy_larga_y_segura_para_jwt_tokens
   JWT_ACCESS_TTL=15m
   JWT_REFRESH_TTL=30d
   ```

2. **Crear base de datos:**
   ```sql
   CREATE DATABASE pib2;
   ```

3. **Ejecutar la aplicaci√≥n:**
   ```bash
   mvn spring-boot:run
   ```
   - Hibernate crear√° las tablas autom√°ticamente
   - Flyway ejecutar√° los seeds de datos iniciales

4. **Verificar que todo funciona:**
   ```sql
   -- Verificar tablas creadas
   \dt
   
   -- Verificar roles creados
   SELECT * FROM roles;
   
   -- Verificar permisos creados
   SELECT * FROM permissions;
   
   -- Verificar usuario administrador
   SELECT user_email, is_active FROM users WHERE user_email = 'admin@sistema.com';
   ```

5. **Verificar seeds de Flyway:**
   ```bash
   mvn flyway:info
   ```

### Usuarios de Prueba

El sistema incluye varios usuarios de prueba para facilitar el desarrollo y testing:

#### üëë Administrador
- **Email**: `admin@sistema.com`
- **Contrase√±a**: `admin123`
- **Rol**: ADMIN (acceso completo)

#### üë®‚Äçüíº Manager
- **Email**: `maria.gonzalez@empresa.com`
- **Contrase√±a**: `password123`
- **Rol**: MANAGER

#### üîç Auditor
- **Email**: `carlos.rodriguez@empresa.com`
- **Contrase√±a**: `password123`
- **Rol**: AUDITOR

#### üí∞ Finance
- **Email**: `ana.martinez@empresa.com`
- **Contrase√±a**: `password123`
- **Rol**: FINANCE

#### üë§ Usuarios Est√°ndar
- **Email**: `luis.fernandez@empresa.com` / `sofia.lopez@empresa.com`
- **Contrase√±a**: `password123`
- **Rol**: USER

#### ‚ùå Usuario Inactivo (para testing)
- **Email**: `pedro.garcia@empresa.com`
- **Contrase√±a**: `password123`
- **Estado**: Inactivo

**üìã Ver archivo `TEST_USERS.md` para detalles completos de usuarios y casos de prueba.**

**‚ö†Ô∏è IMPORTANTE**: Cambiar todas las contrase√±as en producci√≥n

### Tablas de Autenticaci√≥n

#### `users` - Usuarios del sistema
- Informaci√≥n personal y credenciales
- Campos de seguridad (intentos fallidos, bloqueo, MFA)
- Relaci√≥n many-to-many con roles

#### `roles` - Roles del sistema
- Nombres y descripciones de roles
- Estado activo/inactivo
- Relaci√≥n many-to-many con permisos

#### `permissions` - Permisos granulares
- Nombre, recurso y acci√≥n
- Control fino de acceso
- Relaci√≥n many-to-many con roles

#### `refresh_tokens` - Tokens de renovaci√≥n
- Hash del token (no el token plano)
- Informaci√≥n de dispositivo y ubicaci√≥n
- Control de expiraci√≥n y revocaci√≥n

#### `auth_events` - Eventos de autenticaci√≥n
- Log de todos los eventos de login/logout
- Metadatos de sesi√≥n (IP, User-Agent, etc.)
- Estados de √©xito/fallo

#### `audit_log` - Log de auditor√≠a
- Registro de cambios en entidades
- Diferencias antes/despu√©s
- Actor responsable del cambio

#### `jwt_blacklist` - Lista negra de tokens
- Tokens JWT revocados
- Control de expiraci√≥n
- Raz√≥n de revocaci√≥n

## Features ‚ú®

### 1. Gesti√≥n de Usuarios (AppUser)
- Registro y autenticaci√≥n de usuarios
- Perfiles de usuario con roles y permisos
- Gesti√≥n de datos personales

### 2. Gesti√≥n de Transacciones
- Registro de transacciones financieras
- Seguimiento de estados y fechas
- Vinculaci√≥n con centros de costo

### 3. Gesti√≥n de Documentos
- Control de documentos comerciales
- Validaci√≥n de numeraci√≥n
- Asociaci√≥n con terceros

### 4. Gesti√≥n de Proveedores
- Registro de proveedores
- Control de estado y contacto
- Historial de transacciones

### 5. Centros de Costo
- Organizaci√≥n por √°reas
- Control presupuestario
- Reportes por centro de costo

### 6. Gesti√≥n de Almacenes
- Control de ubicaciones
- Gesti√≥n de capacidad
- Seguimiento de movimientos

## Modelo de Datos üóÇÔ∏è

### Entidades Principales

#### AppUser
```java
public class AppUser {
    private Long id;
    private String firstName;
    private String lastName;
    private String email;
    private String password;
    private boolean active;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

#### Transaction
```java
public class Transaction {
    private Long id;
    private String type;
    private BigDecimal amount;
    private LocalDateTime date;
    private String status;
}
```

#### Document
```java
public class Document {
    private Long id;
    private String type;
    private String number;
    private LocalDate issueDate;
}
```

#### Supplier
```java
public class Supplier {
    private Long id;
    private String name;
    private String contactInfo;
    private String status;
}
```

#### CostCenter
```java
public class CostCenter {
    private Long id;
    private String name;
    private String code;
    private String description;
}
```

#### Warehouse
```java
public class Warehouse {
    private Long id;
    private String name;
    private String location;
    private Integer capacity;
}
```

## API Endpoints üõ†Ô∏è

### Usuarios
- GET `/api/users` - Listar usuarios
- POST `/api/users` - Crear usuario
- GET `/api/users/{id}` - Obtener usuario
- PUT `/api/users/{id}` - Actualizar usuario
- DELETE `/api/users/{id}` - Eliminar usuario

### Transacciones
- GET `/api/transactions` - Listar transacciones
- POST `/api/transactions` - Crear transacci√≥n
- GET `/api/transactions/{id}` - Obtener transacci√≥n
- PUT `/api/transactions/{id}` - Actualizar transacci√≥n

### Documentos
- GET `/api/documents` - Listar documentos
- POST `/api/documents` - Crear documento
- GET `/api/documents/{id}` - Obtener documento
- PUT `/api/documents/{id}` - Actualizar documento

### Proveedores
- GET `/api/suppliers` - Listar proveedores
- POST `/api/suppliers` - Crear proveedor
- GET `/api/suppliers/{id}` - Obtener proveedor
- PUT `/api/suppliers/{id}` - Actualizar proveedor

### Centros de Costo
- GET `/api/cost-centers` - Listar centros
- POST `/api/cost-centers` - Crear centro
- GET `/api/cost-centers/{id}` - Obtener centro
- PUT `/api/cost-centers/{id}` - Actualizar centro

### Almacenes
- GET `/api/warehouses` - Listar almacenes
- POST `/api/warehouses` - Crear almac√©n
- GET `/api/warehouses/{id}` - Obtener almac√©n
- PUT `/api/warehouses/{id}` - Actualizar almac√©n

## Reglas de Negocio üìã

1. **Usuarios**
   - Email √∫nico en el sistema
   - Contrase√±a segura requerida
   - Activaci√≥n/desactivaci√≥n controlada

2. **Transacciones**
   - Asociaci√≥n obligatoria a centro de costo
   - No modificables una vez completadas
   - Registro de fecha y usuario

3. **Documentos**
   - N√∫mero √∫nico por tipo
   - Validaci√≥n de fechas
   - Control de estados

4. **Proveedores**
   - Informaci√≥n de contacto requerida
   - Estado activo/inactivo
   - Validaci√≥n de documentos

5. **Centros de Costo**
   - C√≥digo √∫nico
   - Jerarqu√≠a organizacional
   - Control presupuestario

6. **Almacenes**
   - Control de capacidad m√°xima
   - Ubicaci√≥n √∫nica
   - Registro de movimientos

## Estructura del Proyecto üìÅ

```
src/
‚îú‚îÄ‚îÄ main/
‚îÇ   ‚îú‚îÄ‚îÄ java/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ com/example/pib2/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ SecurityConfig.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ SwaggerConfig.java
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ UserController.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ TransactionController.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ DocumentController.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ SupplierController.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ CostCenterController.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ WarehouseController.java
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ model/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ entity/
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BaseEntity.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Role.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Permission.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RefreshToken.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthEvent.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuditLog.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JwtBlacklist.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Transaction.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Document.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ThirdParty.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CostCenter.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Warehouse.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ UserDTO.java
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ TransactionDTO.java
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ DocumentDTO.java
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ SupplierDTO.java
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ CostCenterDTO.java
‚îÇ   ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ WarehouseDTO.java
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ UserRepository.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ TransactionRepository.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ DocumentRepository.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ SupplierRepository.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ CostCenterRepository.java
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ WarehouseRepository.java
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ service/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ UserService.java
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ TransactionService.java
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ DocumentService.java
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ SupplierService.java
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ CostCenterService.java
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ WarehouseService.java
‚îÇ   ‚îî‚îÄ‚îÄ resources/
‚îÇ       ‚îú‚îÄ‚îÄ application.properties
‚îÇ       ‚îú‚îÄ‚îÄ application-dev.properties
‚îÇ       ‚îî‚îÄ‚îÄ application-prod.properties
‚îî‚îÄ‚îÄ test/
    ‚îî‚îÄ‚îÄ java/
        ‚îî‚îÄ‚îÄ com/example/pib2/
            ‚îî‚îÄ‚îÄ service/
                ‚îú‚îÄ‚îÄ UserServiceTest.java
                ‚îú‚îÄ‚îÄ TransactionServiceTest.java
                ‚îú‚îÄ‚îÄ DocumentServiceTest.java
                ‚îú‚îÄ‚îÄ SupplierServiceTest.java
                ‚îú‚îÄ‚îÄ CostCenterServiceTest.java
                ‚îî‚îÄ‚îÄ WarehouseServiceTest.java
```
